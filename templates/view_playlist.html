{% include 'header.html' %}
<h1 class="mt-5">Playlist: {{ playlist.name }}</h1>
<p>{{ playlist.description }}</p>
<p><small class="text-muted">Type: {{ playlist.playlist_type }}</small></p>

<h2 class="mt-4">Current Media Item</h2>
<div id="current-media-viewer">
    <!-- Media player/viewer will be loaded here by JavaScript -->
</div>

<div class="mt-3">
    <button id="prev-media" class="btn btn-secondary">Previous</button>
    <button id="next-media" class="btn btn-secondary">Next</button>
</div>

<h2 class="mt-4">Media Items in Playlist</h2>
{% if playlist_items %}
<ul class="list-group" id="playlist-items">
    {% for item in playlist_items %}
    <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ item.id }}" data-file-type="{{ item.file_type }}" data-filename="{{ item.filename }}" data-title="{{ item.title }}">
        <div>
            <a href="{{ url_for('media_page', media_id=item.id) }}">{{ item.title }}</a>
            <small class="text-muted"> ({{ item.file_type }})</small>
        </div>
        <form action="{{ url_for('remove_media_from_playlist', playlist_id=playlist.id) }}" method="post" style="display: inline-block;">
            <input type="hidden" name="media_id" value="{{ item.id }}">
            <button type="submit" class="btn btn-danger btn-sm">Remove</button>
        </form>
    </li>
    {% endfor %}
</ul>
<button id="save-order" class="btn btn-success mt-3">Save Order</button>
{% else %}
<p>No media items in this playlist yet.</p>
{% endif %}

<h2 class="mt-4">Add Media to Playlist</h2>
<div class="form-group">
    <input type="text" id="media-search-input" class="form-control" placeholder="Search media by title...">
</div>
<div id="media-search-results" class="list-group mb-3"></div>

<a href="{{ url_for('playlists') }}" class="btn btn-secondary mt-3">Back to Playlists</a>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<script>
    var playlistItems = [];
    {% for item in playlist_items %}
        playlistItems.push({
            id: {{ item.id }},
            file_type: '{{ item.file_type }}',
            filename: '{{ item.filename }}',
            title: '{{ item.title }}'
        });
    {% endfor %}

    var currentMediaIndex = 0;

    function loadMedia(index) {
        var viewer = document.getElementById('current-media-viewer');
        viewer.innerHTML = ''; // Clear previous content

        if (playlistItems.length === 0) {
            viewer.innerHTML = '<p>No media to play.</p>';
            return;
        }

        var media = playlistItems[index];
        var mediaUrl = '/api/media/' + media.id + '/download';

        if (media.file_type === 'image') {
            viewer.innerHTML = '<img src="' + mediaUrl + '" class="img-fluid" alt="' + media.title + '">';
        } else if (media.file_type === 'audio') {
            viewer.innerHTML = '<audio controls autoplay><source src="' + mediaUrl + '" type="audio/mpeg">Your browser does not support the audio element.</audio>';
        } else if (media.file_type === 'video') {
            viewer.innerHTML = '<video controls autoplay width="100%"><source src="' + mediaUrl + '" type="video/mp4">Your browser does not support the video tag.</video>';
        } else if (media.file_type === 'ebook') {
            viewer.innerHTML = '<p>Ebook: <a href="' + mediaUrl + '">Download ' + media.title + '</a></p>';
        } else {
            viewer.innerHTML = '<p>Unsupported media type: ' + media.file_type + '</p>';
        }
    }

    document.getElementById('prev-media').addEventListener('click', function () {
        currentMediaIndex = (currentMediaIndex - 1 + playlistItems.length) % playlistItems.length;
        loadMedia(currentMediaIndex);
    });

    document.getElementById('next-media').addEventListener('click', function () {
        currentMediaIndex = (currentMediaIndex + 1) % playlistItems.length;
        loadMedia(currentMediaIndex);
    });

    // Initial load
    if (playlistItems.length > 0) {
        loadMedia(currentMediaIndex);
    }

    // SortableJS for reordering
    var el = document.getElementById('playlist-items');
    var sortable = Sortable.create(el, {
        animation: 150,
        ghostClass: 'blue-background-class',
        onEnd: function (evt) {
            // Update the playlistItems array after drag-and-drop
            var movedItem = playlistItems.splice(evt.oldIndex, 1)[0];
            playlistItems.splice(evt.newIndex, 0, movedItem);
        }
    });

    document.getElementById('save-order').addEventListener('click', function () {
        var order = playlistItems.map(item => item.id); // Get IDs in new order
        fetch('{{ url_for('reorder_media_in_playlist', playlist_id=playlist.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ media_ids: order })
        }).then(response => response.json())
        .then(data => {
            if (data.message) {
                alert(data.message);
            } else if (data.error) {
                alert(data.error);
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the order.');
        });
    });

    // Media search and add to playlist
    var searchInput = document.getElementById('media-search-input');
    var searchResultsDiv = document.getElementById('media-search-results');

    searchInput.addEventListener('input', function () {
        var query = this.value.trim();
        if (query.length > 2) { // Only search if query is at least 3 characters
            fetch('/api/media/search_by_title?q=' + encodeURIComponent(query))
                .then(response => response.json())
                .then(data => {
                    searchResultsDiv.innerHTML = ''; // Clear previous results
                    if (data.length > 0) {
                        data.forEach(media => {
                            var resultItem = document.createElement('div');
                            resultItem.classList.add('list-group-item', 'list-group-item-action', 'd-flex', 'justify-content-between', 'align-items-center');
                            resultItem.innerHTML = `
                                <span>${media.title} (${media.file_type})</span>
                                <button type="button" class="btn btn-sm btn-primary add-to-playlist-btn" data-media-id="${media.id}">Add</button>
                            `;
                            searchResultsDiv.appendChild(resultItem);
                        });
                        // Add event listeners to new buttons
                        searchResultsDiv.querySelectorAll('.add-to-playlist-btn').forEach(button => {
                            button.addEventListener('click', function () {
                                var mediaIdToAdd = this.dataset.mediaId;
                                fetch('{{ url_for('add_media_to_playlist') }}', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded'
                                    },
                                    body: `media_id=${mediaIdToAdd}&playlist_id={{ playlist.id }}`
                                }).then(response => {
                                    // No need to parse JSON, just let the browser follow the redirect
                                    // The flash message will be displayed on the redirected page
                                    if (response.redirected) {
                                        window.location.href = response.url;
                                    }
                                }).catch(error => {
                                    console.error('Error:', error);
                                    alert('An error occurred while adding media to playlist.');
                                });
                            });
                        });
                    } else {
                        searchResultsDiv.innerHTML = '<div class="list-group-item">No results found.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error searching media:', error);
                    searchResultsDiv.innerHTML = '<div class="list-group-item text-danger">Error searching media.</div>';
                });
        } else {
            searchResultsDiv.innerHTML = ''; // Clear results if query is too short
        }
    });
</script>
{% include 'footer.html' %}